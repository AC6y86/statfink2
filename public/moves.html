<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>StatFink Fantasy League - Roster Moves</title>
    <link href="/statfink-styles.css" rel="stylesheet" type="text/css" media="all" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
            font-family: arial, sans-serif;
        }

        .page-header {
            background-color: #556;
            color: #fff;
            font-size: 24px;
            font-family: arial;
            font-weight: 900;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #343443;
        }

        .content-wrapper {
            padding: 20px;
        }

        .controls {
            max-width: 1400px;
            margin: 0 auto 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .controls label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .controls select {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid #556;
            background: #fff;
            color: #333;
        }

        .ir-summary {
            max-width: 1400px;
            margin: 0 auto 20px;
            background: #fff;
            border: 1px solid #556;
        }

        .ir-summary-header {
            background-color: #556;
            color: #fff;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .ir-summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ir-summary-table th {
            background-color: #ddd;
            color: #000;
            font-size: 11px;
            font-weight: bold;
            padding: 5px 8px;
            text-align: left;
            border-bottom: 1px solid #556;
        }

        .ir-summary-table td {
            padding: 4px 8px;
            font-size: 11px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .ir-summary-table tbody tr:nth-child(odd) {
            background-color: #fff;
        }

        .ir-summary-table tbody tr:nth-child(even) {
            background-color: #f0f0f0;
        }

        .moves-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: start;
        }

        .team-moves {
            background: #fff;
            border: 1px solid #556;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .team-header {
            background-color: #556;
            color: #fff;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #343443;
        }

        .moves-section {
            padding: 10px;
        }

        .section-title {
            background-color: #ddd;
            color: #000;
            font-size: 11px;
            font-weight: bold;
            padding: 5px 8px;
            margin: 0 0 8px 0;
            border-bottom: 1px solid #556;
        }

        .move-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .move-item {
            padding: 6px 8px;
            margin-bottom: 6px;
            background: #f0f0f0;
            border-left: 3px solid #556;
            font-size: 11px;
        }

        .move-item.ir-move {
            border-left-color: #b83535;
            background: #ffe0e0;
        }

        .move-item.ir-return-move {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }

        .move-item.trade-move {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .player-info {
            margin-bottom: 3px;
        }

        .move-meta {
            color: #666;
            font-size: 10px;
        }

        .week-badge {
            background: #556;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 5px;
        }

        .no-moves {
            color: #999;
            font-style: italic;
            padding: 8px;
            font-size: 11px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 12px;
        }

        .error {
            background: #b83535;
            color: #fff;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="page-header">
        Roster Moves - 2025 Season
    </div>

    <div class="content-wrapper">
        <div class="controls">
            <label for="weekFilter">Filter by Week:</label>
            <select id="weekFilter">
                <option value="all">All Weeks</option>
            </select>
        </div>

        <div id="irSummary" class="ir-summary" style="display: none;">
            <div class="ir-summary-header">IR Moves by Team</div>
            <table class="ir-summary-table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Owner</th>
                        <th style="text-align: center;">IR Moves</th>
                        <th style="text-align: center;">IR Returns</th>
                        <th style="text-align: center;">Supplemental</th>
                        <th style="text-align: center;">Trades</th>
                    </tr>
                </thead>
                <tbody id="irSummaryBody">
                </tbody>
            </table>
        </div>

        <div id="loadingMessage" class="loading">Loading roster moves...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="moves-grid" id="movesGrid" style="display: none;">
            <!-- Team moves will be populated here -->
        </div>
    </div>

    <script>
        let allTeamsData = {};
        let currentWeekFilter = 'all';

        async function loadRosterMoves() {
            try {
                const response = await fetch('/api/roster-moves?season=2025');
                if (!response.ok) {
                    throw new Error('Failed to load roster moves');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Failed to load data');
                }

                allTeamsData = result.data;
                populateWeekFilter();
                displayIRSummary();
                displayRosterMoves();

            } catch (error) {
                console.error('Error loading roster moves:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error loading roster moves: ' + error.message;
            }
        }

        function populateWeekFilter() {
            const weekSet = new Set();

            Object.values(allTeamsData).forEach(team => {
                [...team.ir_moves, ...(team.supplemental_moves || []),
                 ...(team.ir_return_moves || []), ...(team.trade_moves || [])].forEach(move => {
                    weekSet.add(move.week);
                });
            });

            const weeks = Array.from(weekSet).sort((a, b) => a - b);
            const select = document.getElementById('weekFilter');

            weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Week ${week}`;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                currentWeekFilter = e.target.value;
                displayRosterMoves();
            });
        }

        function displayIRSummary() {
            const tbody = document.getElementById('irSummaryBody');
            tbody.innerHTML = '';

            const teams = Object.values(allTeamsData).sort((a, b) =>
                a.owner_name.localeCompare(b.owner_name)
            );

            teams.forEach(team => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${team.team_name}</td>
                    <td>${team.owner_name}</td>
                    <td style="text-align: center;">${team.ir_move_count}</td>
                    <td style="text-align: center;">${team.ir_return_count || 0}</td>
                    <td style="text-align: center;">${team.supplemental_move_count || 0}</td>
                    <td style="text-align: center;">${team.trade_count || 0}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('irSummary').style.display = 'block';
        }

        function filterMovesByWeek(moves) {
            if (currentWeekFilter === 'all') {
                return moves;
            }
            return moves.filter(move => move.week === parseInt(currentWeekFilter));
        }

        function displayRosterMoves() {
            const container = document.getElementById('movesGrid');
            const loading = document.getElementById('loadingMessage');

            container.innerHTML = '';

            const teams = Object.values(allTeamsData).sort((a, b) =>
                a.owner_name.localeCompare(b.owner_name)
            );

            teams.forEach(team => {
                const filteredIRMoves = filterMovesByWeek(team.ir_moves);
                const filteredSupplemental = filterMovesByWeek(team.supplemental_moves || []);
                const filteredIRReturns = filterMovesByWeek(team.ir_return_moves || []);
                const filteredTrades = filterMovesByWeek(team.trade_moves || []);

                const hasAnyMoves = filteredIRMoves.length > 0 ||
                                   filteredSupplemental.length > 0 ||
                                   filteredIRReturns.length > 0 ||
                                   filteredTrades.length > 0;

                // Skip teams with no moves if filtering by week
                if (currentWeekFilter !== 'all' && !hasAnyMoves) {
                    return;
                }

                const teamCard = document.createElement('div');
                teamCard.className = 'team-moves';

                // Extract first name from owner_name
                const firstName = team.owner_name ? team.owner_name.split(' ')[0].replace("'s", '') : team.team_name;

                let html = `
                    <div class="team-header">${firstName}</div>
                `;

                // IR Moves section
                html += `
                    <div class="moves-section">
                        <div class="section-title">IR Moves (${filteredIRMoves.length})</div>
                        <ul class="move-list">
                `;

                if (filteredIRMoves.length > 0) {
                    filteredIRMoves.forEach(move => {
                        const moveDate = new Date(move.move_timestamp);
                        const dateStr = moveDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeStr = moveDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        html += `
                            <li class="move-item ir-move">
                                <div class="player-info">
                                    <strong>${move.dropped_player_name}</strong> (${move.dropped_player_position}) → IR<br>
                                    <strong>${move.added_player_name}</strong> (${move.added_player_position}) added
                                </div>
                                <div class="move-meta">
                                    <span class="week-badge">Week ${move.week}</span>
                                    ${dateStr} ${timeStr}
                                </div>
                            </li>
                        `;
                    });
                } else {
                    html += '<li class="no-moves">No IR moves</li>';
                }

                html += '</ul></div>';

                // Supplemental Moves section
                html += `
                    <div class="moves-section">
                        <div class="section-title">Supplemental Moves (${filteredSupplemental.length})</div>
                        <ul class="move-list">
                `;

                if (filteredSupplemental.length > 0) {
                    filteredSupplemental.forEach(move => {
                        const moveDate = new Date(move.move_timestamp);
                        const dateStr = moveDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeStr = moveDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        html += `
                            <li class="move-item">
                                <div class="player-info">
                                    Dropped: <strong>${move.dropped_player_name}</strong> (${move.dropped_player_position})<br>
                                    Added: <strong>${move.added_player_name}</strong> (${move.added_player_position})
                                </div>
                                <div class="move-meta">
                                    <span class="week-badge">Week ${move.week}</span>
                                    ${dateStr} ${timeStr}
                                </div>
                            </li>
                        `;
                    });
                } else {
                    html += '<li class="no-moves">No supplemental moves</li>';
                }

                html += '</ul></div>';

                // IR Returns section
                html += `
                    <div class="moves-section">
                        <div class="section-title">IR Returns (${filteredIRReturns.length})</div>
                        <ul class="move-list">
                `;

                if (filteredIRReturns.length > 0) {
                    filteredIRReturns.forEach(move => {
                        const moveDate = new Date(move.move_timestamp);
                        const dateStr = moveDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeStr = moveDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        html += `
                            <li class="move-item ir-return-move">
                                <div class="player-info">
                                    <strong>${move.added_player_name}</strong> (${move.added_player_position}) ← IR<br>
                                    Dropped: <strong>${move.dropped_player_name}</strong> (${move.dropped_player_position})
                                </div>
                                <div class="move-meta">
                                    <span class="week-badge">Week ${move.week}</span>
                                    ${dateStr} ${timeStr}
                                </div>
                            </li>
                        `;
                    });
                } else {
                    html += '<li class="no-moves">No IR returns</li>';
                }

                html += '</ul></div>';

                // Trades section
                html += `
                    <div class="moves-section">
                        <div class="section-title">Trades (${filteredTrades.length})</div>
                        <ul class="move-list">
                `;

                if (filteredTrades.length > 0) {
                    filteredTrades.forEach(move => {
                        const moveDate = new Date(move.move_timestamp);
                        const dateStr = moveDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeStr = moveDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        html += `
                            <li class="move-item trade-move">
                                <div class="player-info">
                                    Traded: <strong>${move.dropped_player_name}</strong> (${move.dropped_player_position})<br>
                                    Received: <strong>${move.added_player_name}</strong> (${move.added_player_position})
                                    ${move.notes ? `<br><em style="color: #666;">${move.notes}</em>` : ''}
                                </div>
                                <div class="move-meta">
                                    <span class="week-badge">Week ${move.week}</span>
                                    ${dateStr} ${timeStr}
                                </div>
                            </li>
                        `;
                    });
                } else {
                    html += '<li class="no-moves">No trades</li>';
                }

                html += '</ul></div>';

                teamCard.innerHTML = html;
                container.appendChild(teamCard);
            });

            // Show content and hide loading
            loading.style.display = 'none';
            container.style.display = 'grid';
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadRosterMoves);
    </script>
</body>
</html>
