<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatFink Database Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: #666;
            font-size: 1.1rem;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box, .filter-select {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .search-box:focus, .filter-select:focus {
            border-color: #667eea;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            min-width: 150px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .position-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .position-QB { background: #e74c3c; }
        .position-RB { background: #2ecc71; }
        .position-WR { background: #3498db; }
        .position-TE { background: #f39c12; }
        .position-K { background: #9b59b6; }
        .position-DST { background: #34495e; }

        .team-badge {
            padding: 0.25rem 0.5rem;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-healthy { background: #28a745; }
        .status-unhealthy { background: #dc3545; }
        .status-warning { background: #ffc107; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-stat {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .quick-stat h4 {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .quick-stat p {
            color: #666;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box, .filter-select {
                min-width: 100%;
            }

            table {
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        /* Roster Management Styles */
        .roster-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
        }

        .form-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .roster-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .roster-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .roster-section {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .roster-section h5 {
            margin: 0 0 0.75rem 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .roster-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .roster-player:last-child {
            margin-bottom: 0;
        }

        .player-info {
            font-weight: 500;
            color: #212529;
        }

        .player-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        @media (max-width: 768px) {
            .roster-controls {
                flex-direction: column;
            }
            
            .roster-player {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .player-actions {
                align-self: stretch;
                justify-content: space-between;
            }
        }

        /* Settings Tab Styles */
        .settings-form {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .form-group input {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus {
            border-color: #667eea;
        }

        .form-help {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .messages {
            margin: 1rem 0;
            padding: 0;
        }

        .message {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .message.success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .message.error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .message.info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .settings-display {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 600;
            color: #333;
        }

        .setting-value {
            color: #667eea;
            font-weight: 500;
        }

        .snapshot-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            margin-bottom: 1rem;
        }

        .snapshots-display {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .snapshot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        .snapshot-item:last-child {
            margin-bottom: 0;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèà StatFink Database Dashboard</h1>
        <p>Fantasy Football League Management System</p>
    </div>

    <div class="container">
        <!-- Overview Stats -->
        <div id="overview-stats" class="stats-grid">
            <div class="stat-card">
                <h3 id="total-players">...</h3>
                <p>Total Players</p>
            </div>
            <div class="stat-card">
                <h3 id="total-teams">...</h3>
                <p>League Teams</p>
            </div>
            <div class="stat-card">
                <h3 id="rostered-players">...</h3>
                <p>Rostered Players</p>
            </div>
            <div class="stat-card">
                <h3 id="available-players">...</h3>
                <p>Available Players</p>
            </div>
        </div>

        <!-- System Status -->
        <div class="section">
            <h2>üîß System Status</h2>
            <div id="system-status" class="sync-status">
                <div class="status-indicator status-warning"></div>
                <span>Loading system status...</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('players')">Players</button>
            <button class="tab" onclick="showTab('teams')">Teams</button>
            <button class="tab" onclick="showTab('rosters')">Rosters</button>
            <button class="tab" onclick="showTab('stats')">Statistics</button>
            <button class="tab" onclick="showTab('admin')">Admin</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Players Tab -->
        <div id="players-tab" class="tab-content active">
            <div class="section">
                <h2>üë• NFL Players Database</h2>
                
                <div id="players-stats" class="quick-stats">
                    <div class="quick-stat">
                        <h4 id="qb-count">-</h4>
                        <p>Quarterbacks</p>
                    </div>
                    <div class="quick-stat">
                        <h4 id="rb-count">-</h4>
                        <p>Running Backs</p>
                    </div>
                    <div class="quick-stat">
                        <h4 id="wr-count">-</h4>
                        <p>Wide Receivers</p>
                    </div>
                    <div class="quick-stat">
                        <h4 id="te-count">-</h4>
                        <p>Tight Ends</p>
                    </div>
                    <div class="quick-stat">
                        <h4 id="k-count">-</h4>
                        <p>Kickers</p>
                    </div>
                    <div class="quick-stat">
                        <h4 id="dst-count">-</h4>
                        <p>Defenses</p>
                    </div>
                </div>

                <div class="controls">
                    <input type="text" id="player-search" class="search-box" placeholder="Search players by name...">
                    <select id="position-filter" class="filter-select">
                        <option value="">All Positions</option>
                        <option value="QB">QB</option>
                        <option value="RB">RB</option>
                        <option value="WR">WR</option>
                        <option value="TE">TE</option>
                        <option value="K">K</option>
                        <option value="DST">DST</option>
                    </select>
                    <select id="team-filter" class="filter-select">
                        <option value="">All Teams</option>
                    </select>
                    <button class="btn" onclick="loadPlayers()">Refresh</button>
                </div>

                <div class="table-container">
                    <table id="players-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Position</th>
                                <th>Team</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="players-tbody">
                            <tr><td colspan="5" class="loading">Loading players...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="players-pagination" class="pagination"></div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teams-tab" class="tab-content">
            <div class="section">
                <h2>üèÜ Fantasy Teams</h2>
                <div class="table-container">
                    <table id="teams-table">
                        <thead>
                            <tr>
                                <th>Team Name</th>
                                <th>Owner</th>
                                <th>Wins</th>
                                <th>Losses</th>
                                <th>Ties</th>
                                <th>Total Points</th>
                                <th>Roster Size</th>
                            </tr>
                        </thead>
                        <tbody id="teams-tbody">
                            <tr><td colspan="7" class="loading">Loading teams...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rosters Tab -->
        <div id="rosters-tab" class="tab-content">
            <div class="section">
                <h2>üìã Team Rosters</h2>
                <div id="roster-week-info" class="sync-status">
                    <div class="status-indicator status-warning"></div>
                    <span>Loading week information...</span>
                </div>
                <div class="controls">
                    <select id="roster-team-filter" class="filter-select">
                        <option value="">Select Team</option>
                    </select>
                    <button class="btn" onclick="loadRoster()">View Roster</button>
                    <button class="btn btn-secondary" onclick="refreshRosterInfo()">Refresh</button>
                </div>

                <div class="table-container">
                    <table id="roster-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Position</th>
                                <th>NFL Team</th>
                                <th>Roster Position</th>
                                <th>Bye Week</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody">
                            <tr><td colspan="5" class="loading">Select a team to view roster...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="stats-tab" class="tab-content">
            <div class="section">
                <h2>üìä Database Statistics</h2>
                <div id="db-stats" class="quick-stats">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è Admin Controls</h2>
                
                <div class="controls">
                    <button class="btn" onclick="syncPlayers()">Sync Players</button>
                    <button class="btn btn-secondary" onclick="checkSyncStatus()">Check Status</button>
                </div>

                <div id="admin-messages"></div>

                <!-- Roster Management Section -->
                <div class="section">
                    <h3>üèà Roster Management</h3>
                    
                    <div class="roster-controls">
                        <div class="form-group">
                            <label for="team-select">Select Team:</label>
                            <select id="team-select" onchange="loadTeamRoster()">
                                <option value="">Choose a team...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="player-select">Add Player:</label>
                            <select id="player-select">
                                <option value="">Choose a player...</option>
                            </select>
                            <select id="position-select">
                                <option value="starter">Starter</option>
                                <option value="injured_reserve">Injured Reserve</option>
                            </select>
                            <button class="btn btn-small" onclick="addPlayerToRoster()">Add to Roster</button>
                        </div>
                    </div>

                    <div id="current-roster" class="roster-display">
                        <h4>Current Roster</h4>
                        <div id="roster-content">Select a team to view roster</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Player Sync</strong></td>
                                <td>Synchronize NFL players from Tank01 API</td>
                                <td><span id="sync-status">Unknown</span></td>
                            </tr>
                            <tr>
                                <td><strong>Database Health</strong></td>
                                <td>Check database connection and integrity</td>
                                <td><span id="db-health">Unknown</span></td>
                            </tr>
                            <tr>
                                <td><strong>API Health</strong></td>
                                <td>Check Tank01 API connectivity</td>
                                <td><span id="api-health">Unknown</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è League Settings</h2>
                <p>Adjust league settings for debugging and testing purposes</p>
                
                <div class="settings-form">
                    <div class="form-group">
                        <label for="current-week">Current Week:</label>
                        <input type="number" id="current-week" min="1" max="18" placeholder="Enter week (1-18)">
                        <span class="form-help">Set the current week for the fantasy season</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="season-year">Season Year:</label>
                        <input type="number" id="season-year" min="2020" max="2030" placeholder="Enter year (2020-2030)">
                        <span class="form-help">Set the fantasy season year</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="league-name">League Name:</label>
                        <input type="text" id="league-name" placeholder="Enter league name">
                        <span class="form-help">Set the fantasy league name</span>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn" onclick="updateSettings()">Update Settings</button>
                        <button class="btn btn-secondary" onclick="loadCurrentSettings()">Reset to Current</button>
                    </div>
                </div>
                
                <div id="settings-messages" class="messages"></div>
                
                <!-- Current Settings Display -->
                <div class="section">
                    <h3>üìä Current Settings</h3>
                    <div id="current-settings" class="settings-display">
                        <div class="loading">Loading current settings...</div>
                    </div>
                </div>
                
                <!-- Roster Snapshot Controls -->
                <div class="section">
                    <h3>üìã Roster Snapshots</h3>
                    <p>Capture and manage weekly roster snapshots for tracking changes</p>
                    
                    <div class="snapshot-controls">
                        <div class="form-group">
                            <label for="snapshot-week">Week to Capture:</label>
                            <input type="number" id="snapshot-week" min="1" max="18" placeholder="Week number">
                            <button class="btn" onclick="captureSnapshot()">Capture Snapshot</button>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="showAvailableSnapshots()">Show Available Snapshots</button>
                        </div>
                    </div>
                    
                    <div id="snapshot-messages" class="messages"></div>
                    <div id="available-snapshots" class="snapshots-display"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let playersPerPage = 50;
        let allPlayers = [];
        let filteredPlayers = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewStats();
            loadSystemStatus();
            loadPlayers();
            loadTeams();
            loadTeamFilters();
            
            // Set up search functionality
            document.getElementById('player-search').addEventListener('input', filterPlayers);
            document.getElementById('position-filter').addEventListener('change', filterPlayers);
            document.getElementById('team-filter').addEventListener('change', filterPlayers);
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'teams') {
                loadTeams();
            } else if (tabName === 'rosters') {
                loadTeamFilters();
                loadRosterWeekInfo();
            } else if (tabName === 'stats') {
                loadDatabaseStats();
            } else if (tabName === 'admin') {
                console.time('Admin Tab Load');
                console.log('üîÑ Loading Admin tab...');
                
                console.time('checkSyncStatus');
                console.log('üîÑ Checking sync status...');
                checkSyncStatus().then(() => {
                    console.timeEnd('checkSyncStatus');
                    console.log('‚úÖ Sync status loaded');
                });
                
                console.time('loadTeamsForRoster');
                console.log('üîÑ Loading teams for roster...');
                loadTeamsForRoster().then(() => {
                    console.timeEnd('loadTeamsForRoster');
                    console.log('‚úÖ Teams for roster loaded');
                });
                
                console.time('loadAvailablePlayers');
                console.log('üîÑ Loading available players...');
                loadAvailablePlayers().then(() => {
                    console.timeEnd('loadAvailablePlayers');
                    console.log('‚úÖ Available players loaded');
                    console.timeEnd('Admin Tab Load');
                    console.log('üéâ Admin tab fully loaded');
                });
            }
        }

        // Load overview statistics
        async function loadOverviewStats() {
            try {
                const [playersRes, teamsRes] = await Promise.all([
                    fetch('/api/players'),
                    fetch('/api/teams')
                ]);

                const players = await playersRes.json();
                const teams = await teamsRes.json();

                // Count rostered players
                const rosteredRes = await fetch('/api/admin/dashboard').catch(() => ({ json: () => ({ data: { summary: { rosteredPlayers: 0 } } }) }));
                
                const dashboardData = await rosteredRes.json().catch(() => ({ data: { summary: { rosteredPlayers: 0 } } }));

                document.getElementById('total-players').textContent = players.data.length;
                document.getElementById('total-teams').textContent = teams.data.length;
                document.getElementById('rostered-players').textContent = dashboardData.data?.summary?.rosteredPlayers || '0';
                document.getElementById('available-players').textContent = 
                    players.data.length - (dashboardData.data?.summary?.rosteredPlayers || 0);

                // Update position counts
                const positions = {};
                players.data.forEach(player => {
                    positions[player.position] = (positions[player.position] || 0) + 1;
                });

                document.getElementById('qb-count').textContent = positions.QB || 0;
                document.getElementById('rb-count').textContent = positions.RB || 0;
                document.getElementById('wr-count').textContent = positions.WR || 0;
                document.getElementById('te-count').textContent = positions.TE || 0;
                document.getElementById('k-count').textContent = positions.K || 0;
                document.getElementById('dst-count').textContent = positions.DST || 0;

            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                const statusEl = document.getElementById('system-status');
                const indicator = statusEl.querySelector('.status-indicator');
                
                if (health.status === 'healthy') {
                    indicator.className = 'status-indicator status-healthy';
                    statusEl.innerHTML = `
                        <div class="status-indicator status-healthy"></div>
                        <div>
                            <strong>System Healthy</strong><br>
                            Database: ${health.services.database} | Tank01: ${health.services.tank01}
                            ${health.tank01_stats ? ` | API Requests: ${health.tank01_stats.requests}` : ''}
                        </div>
                    `;
                } else {
                    indicator.className = 'status-indicator status-unhealthy';
                    statusEl.innerHTML = `
                        <div class="status-indicator status-unhealthy"></div>
                        <span><strong>System Issues</strong> - ${health.error || 'Unknown error'}</span>
                    `;
                }
            } catch (error) {
                const statusEl = document.getElementById('system-status');
                statusEl.innerHTML = `
                    <div class="status-indicator status-unhealthy"></div>
                    <span><strong>Connection Error</strong> - Unable to reach server</span>
                `;
            }
        }

        // Load players data
        async function loadPlayers() {
            try {
                const response = await fetch('/api/players');
                const data = await response.json();
                allPlayers = data.data;
                filteredPlayers = [...allPlayers];
                
                displayPlayers();
                updatePagination();
            } catch (error) {
                document.getElementById('players-tbody').innerHTML = 
                    '<tr><td colspan="5" class="error">Error loading players: ' + error.message + '</td></tr>';
            }
        }

        // Filter players
        function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const positionFilter = document.getElementById('position-filter').value;
            const teamFilter = document.getElementById('team-filter').value;

            filteredPlayers = allPlayers.filter(player => {
                const matchesSearch = player.name.toLowerCase().includes(searchTerm);
                const matchesPosition = !positionFilter || player.position === positionFilter;
                const matchesTeam = !teamFilter || player.team === teamFilter;
                
                return matchesSearch && matchesPosition && matchesTeam;
            });

            currentPage = 1;
            displayPlayers();
            updatePagination();
        }

        // Display players with pagination
        function displayPlayers() {
            const startIndex = (currentPage - 1) * playersPerPage;
            const endIndex = startIndex + playersPerPage;
            const playersToShow = filteredPlayers.slice(startIndex, endIndex);

            const tbody = document.getElementById('players-tbody');
            
            if (playersToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">No players found</td></tr>';
                return;
            }

            tbody.innerHTML = playersToShow.map(player => `
                <tr>
                    <td><strong>${player.name}</strong></td>
                    <td><span class="position-badge position-${player.position}">${player.position}</span></td>
                    <td><span class="team-badge">${player.team}</span></td>
                    <td>${new Date(player.last_updated).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
            const paginationEl = document.getElementById('players-pagination');
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})">‚Äπ Previous</button>`;
            }
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next ‚Ä∫</button>`;
            }

            paginationEl.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayPlayers();
            updatePagination();
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const data = await response.json();
                
                const tbody = document.getElementById('teams-tbody');
                tbody.innerHTML = data.data.map(team => `
                    <tr>
                        <td><strong>${team.team_name}</strong></td>
                        <td>${team.owner_name}</td>
                        <td>${team.wins}</td>
                        <td>${team.losses}</td>
                        <td>${team.ties}</td>
                        <td>${team.total_points.toFixed(1)}</td>
                        <td><span id="roster-size-${team.team_id}">-</span></td>
                    </tr>
                `).join('');

                // Load roster sizes for each team
                data.data.forEach(async team => {
                    try {
                        const rosterRes = await fetch(`/api/teams/${team.team_id}/roster`);
                        const rosterData = await rosterRes.json();
                        document.getElementById(`roster-size-${team.team_id}`).textContent = rosterData.data.length;
                    } catch (error) {
                        document.getElementById(`roster-size-${team.team_id}`).textContent = 'Error';
                    }
                });

            } catch (error) {
                document.getElementById('teams-tbody').innerHTML = 
                    '<tr><td colspan="7" class="error">Error loading teams: ' + error.message + '</td></tr>';
            }
        }

        // Load team filters
        async function loadTeamFilters() {
            try {
                const [playersRes, teamsRes] = await Promise.all([
                    fetch('/api/players'),
                    fetch('/api/teams')
                ]);

                const players = await playersRes.json();
                const teams = await teamsRes.json();

                // Populate team filter for players
                const teamFilter = document.getElementById('team-filter');
                const uniqueTeams = [...new Set(players.data.map(p => p.team))].sort();
                teamFilter.innerHTML = '<option value="">All Teams</option>' + 
                    uniqueTeams.map(team => `<option value="${team}">${team}</option>`).join('');

                // Populate team filter for rosters
                const rosterTeamFilter = document.getElementById('roster-team-filter');
                rosterTeamFilter.innerHTML = '<option value="">Select Team</option>' + 
                    teams.data.map(team => `<option value="${team.team_id}">${team.team_name}</option>`).join('');

            } catch (error) {
                console.error('Error loading team filters:', error);
            }
        }

        // Load and display current week information for rosters
        async function loadRosterWeekInfo() {
            try {
                console.log('Loading roster week info...');
                const settingsResponse = await fetch('/api/league/settings');
                const settingsData = await settingsResponse.json();
                console.log('Settings data:', settingsData);
                
                const rosterWeekInfo = document.getElementById('roster-week-info');
                
                if (settingsData.success) {
                    const currentWeek = settingsData.data.current_week;
                    const currentSeason = settingsData.data.season_year;
                    
                    if (currentWeek && currentSeason) {
                        // Check if weekly roster data exists for this week
                        try {
                            console.log(`Checking snapshot for week ${currentWeek}, season ${currentSeason}`);
                            const snapshotResponse = await fetch(`/api/roster-history/exists/${currentWeek}/${currentSeason}`);
                            const snapshotData = await snapshotResponse.json();
                            console.log('Snapshot data:', snapshotData);
                            
                            if (snapshotData.exists) {
                                rosterWeekInfo.innerHTML = `
                                    <div class="status-indicator status-healthy"></div>
                                    <span><strong>Showing Week ${currentWeek}, ${currentSeason}</strong> - Weekly roster data available</span>
                                `;
                            } else {
                                rosterWeekInfo.innerHTML = `
                                    <div class="status-indicator status-unhealthy"></div>
                                    <span><strong>Week ${currentWeek}, ${currentSeason}</strong> - No roster snapshot exists for this week</span>
                                `;
                            }
                        } catch (snapshotError) {
                            rosterWeekInfo.innerHTML = `
                                <div class="status-indicator status-unhealthy"></div>
                                <span><strong>Week ${currentWeek}, ${currentSeason}</strong> - Error checking roster snapshot availability</span>
                            `;
                        }
                    } else {
                        rosterWeekInfo.innerHTML = `
                            <div class="status-indicator status-unhealthy"></div>
                            <span><strong>Week/Season not set</strong> - Cannot display rosters</span>
                        `;
                    }
                } else {
                    rosterWeekInfo.innerHTML = `
                        <div class="status-indicator status-unhealthy"></div>
                        <span><strong>Error loading settings</strong> - Cannot display rosters</span>
                    `;
                }
            } catch (error) {
                console.error('Error in loadRosterWeekInfo:', error);
                document.getElementById('roster-week-info').innerHTML = `
                    <div class="status-indicator status-unhealthy"></div>
                    <span><strong>Connection Error</strong> - Unable to load week information</span>
                `;
            }
        }

        // Refresh roster information
        async function refreshRosterInfo() {
            await loadRosterWeekInfo();
            // If a team is selected, reload its roster
            const selectedTeam = document.getElementById('roster-team-filter').value;
            if (selectedTeam) {
                await loadRoster();
            }
        }

        // Load roster for selected team
        async function loadRoster() {
            const teamId = document.getElementById('roster-team-filter').value;
            const tbody = document.getElementById('roster-tbody');
            
            if (!teamId) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Select a team to view roster...</td></tr>';
                return;
            }

            try {
                // First get current league settings to determine week and season
                const settingsResponse = await fetch('/api/league/settings');
                const settingsData = await settingsResponse.json();
                
                let currentWeek = settingsData.success ? settingsData.data.current_week : null;
                let currentSeason = settingsData.success ? settingsData.data.season_year : null;
                
                let response, data;
                
                // Try to get weekly roster data if week is set
                if (currentWeek && currentSeason) {
                    try {
                        response = await fetch(`/api/roster-history/team/${teamId}/week/${currentWeek}/${currentSeason}`);
                        data = await response.json();
                        
                        if (data.success && data.roster && data.roster.length > 0) {
                            // Use weekly roster data
                            tbody.innerHTML = data.roster.map(player => `
                                <tr>
                                    <td><strong>${player.name}</strong></td>
                                    <td><span class="position-badge position-${player.position}">${player.position}</span></td>
                                    <td><span class="team-badge">${player.team}</span></td>
                                    <td>${player.roster_position}</td>
                                    <td>${player.bye_week || 'TBD'}</td>
                                </tr>
                            `).join('');
                            return;
                        } else {
                            // No roster snapshot exists for this week
                            tbody.innerHTML = `<tr><td colspan="5" class="error">No roster snapshot exists for Week ${currentWeek}, ${currentSeason}. Use the Settings tab to capture a roster snapshot for this week.</td></tr>`;
                            return;
                        }
                    } catch (weeklyError) {
                        // Error fetching weekly data
                        tbody.innerHTML = `<tr><td colspan="5" class="error">Error loading roster for Week ${currentWeek}, ${currentSeason}: ${weeklyError.message}</td></tr>`;
                        return;
                    }
                } else {
                    // No week/season set in settings
                    tbody.innerHTML = '<tr><td colspan="5" class="error">Week and season must be set in Settings to view rosters. Please configure these values first.</td></tr>';
                    return;
                }

            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="error">Error loading roster: ' + error.message + '</td></tr>';
            }
        }

        // Load database statistics
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                const statsHTML = `
                    <div class="quick-stat">
                        <h4>${health.status === 'healthy' ? '‚úÖ' : '‚ùå'}</h4>
                        <p>System Health</p>
                    </div>
                    <div class="quick-stat">
                        <h4>${health.services?.database === 'connected' ? '‚úÖ' : '‚ùå'}</h4>
                        <p>Database Status</p>
                    </div>
                    <div class="quick-stat">
                        <h4>${health.services?.tank01 === 'healthy' ? '‚úÖ' : health.services?.tank01 === 'initialized' ? '‚ö†Ô∏è' : '‚ùå'}</h4>
                        <p>Tank01 API</p>
                    </div>
                    <div class="quick-stat">
                        <h4>${health.tank01_stats?.requests || 0}</h4>
                        <p>API Requests Made</p>
                    </div>
                    <div class="quick-stat">
                        <h4>${health.tank01_stats?.cache_size || 0}</h4>
                        <p>Cached Responses</p>
                    </div>
                    <div class="quick-stat">
                        <h4>${health.version}</h4>
                        <p>Application Version</p>
                    </div>
                `;
                
                document.getElementById('db-stats').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('db-stats').innerHTML = 
                    '<div class="error">Error loading database statistics</div>';
            }
        }

        // Admin functions
        function showMessage(message, type = 'success') {
            const messagesEl = document.getElementById('admin-messages');
            messagesEl.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => messagesEl.innerHTML = '', 5000);
        }

        async function syncPlayers() {
            try {
                showMessage('Starting player sync...', 'success');
                
                const response = await fetch('/api/admin/sync/players', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(`Player sync completed! Synced ${result.data.players_synced} players in ${result.data.duration}ms`, 'success');
                    loadOverviewStats(); // Refresh stats
                    loadPlayers(); // Refresh player list
                } else {
                    showMessage(`Sync failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        async function checkSyncStatus() {
            try {
                console.time('API: /api/admin/sync/status');
                const response = await fetch('/api/admin/sync/status');
                console.timeEnd('API: /api/admin/sync/status');

                const result = await response.json();
                
                document.getElementById('sync-status').textContent = 
                    result.data.sync.sync_in_progress ? 'In Progress' : 
                    result.data.sync.last_sync ? `Last: ${new Date(result.data.sync.last_sync).toLocaleString()}` : 'Never';
                
                document.getElementById('db-health').textContent = '‚úÖ Connected';
                document.getElementById('api-health').textContent = 
                    result.data.tank01?.status === 'healthy' ? '‚úÖ Healthy' : 
                    result.data.tank01?.status === 'unhealthy' ? '‚ùå Unhealthy' : 
                    '‚ö†Ô∏è Not configured';

            } catch (error) {
                console.error('checkSyncStatus error:', error);
                document.getElementById('sync-status').textContent = 'Error';
                document.getElementById('db-health').textContent = 'Error';
                document.getElementById('api-health').textContent = 'Error';
            }
        }

        // Roster Management Functions
        async function loadTeamsForRoster() {
            try {
                console.time('API: /api/teams');
                const response = await fetch('/api/teams');
                console.timeEnd('API: /api/teams');
                const data = await response.json();
                
                const teamSelect = document.getElementById('team-select');
                teamSelect.innerHTML = '<option value="">Choose a team...</option>';
                
                data.data.forEach(team => {
                    teamSelect.innerHTML += `<option value="${team.team_id}">${team.team_name} (${team.owner_name})</option>`;
                });
            } catch (error) {
                console.error('loadTeamsForRoster error:', error);
                showMessage(`Error loading teams: ${error.message}`, 'error');
            }
        }

        async function loadAvailablePlayers() {
            try {
                console.time('API: /api/players/available');
                const response = await fetch('/api/players/available');
                console.timeEnd('API: /api/players/available');
                const data = await response.json();
                
                const playerSelect = document.getElementById('player-select');
                
                // Build HTML string first, then set innerHTML once
                let html = '<option value="">Choose a player...</option>';
                
                // Group by position for easier selection
                const positions = ['QB', 'RB', 'WR', 'TE', 'K', 'DST'];
                positions.forEach(position => {
                    const positionPlayers = data.data.filter(p => p.position === position);
                    if (positionPlayers.length > 0) {
                        html += `<optgroup label="${position}">`;
                        positionPlayers.forEach(player => {
                            html += `<option value="${player.player_id}">${player.name} (${player.team})</option>`;
                        });
                        html += `</optgroup>`;
                    }
                });
                
                // Set innerHTML once at the end
                playerSelect.innerHTML = html;
            } catch (error) {
                console.error('loadAvailablePlayers error:', error);
                showMessage(`Error loading available players: ${error.message}`, 'error');
            }
        }

        async function loadTeamRoster() {
            const teamId = document.getElementById('team-select').value;
            const rosterContent = document.getElementById('roster-content');
            
            if (!teamId) {
                rosterContent.innerHTML = 'Select a team to view roster';
                return;
            }

            try {
                const response = await fetch(`/api/teams/${teamId}/roster`);
                const data = await response.json();
                
                if (data.data.roster.length === 0) {
                    rosterContent.innerHTML = '<p>No players on roster</p>';
                    return;
                }

                let rosterHTML = '<div class="roster-grid">';
                
                // Group by roster position
                const starters = data.data.starters || [];
                const ir = data.data.injuredReserve || [];
                
                if (starters.length > 0) {
                    rosterHTML += '<div class="roster-section"><h5>Starters</h5>';
                    starters.forEach(player => {
                        rosterHTML += `
                            <div class="roster-player">
                                <span class="player-info">${player.name} (${player.position} - ${player.team})</span>
                                <div class="player-actions">
                                    <button class="btn btn-small" onclick="movePlayer('${teamId}', '${player.player_id}', 'injured_reserve')">To IR</button>
                                    <button class="btn btn-small btn-danger" onclick="removePlayer('${teamId}', '${player.player_id}')">Remove</button>
                                </div>
                            </div>
                        `;
                    });
                    rosterHTML += '</div>';
                }
                
                
                if (ir.length > 0) {
                    rosterHTML += '<div class="roster-section"><h5>Injured Reserve</h5>';
                    ir.forEach(player => {
                        rosterHTML += `
                            <div class="roster-player">
                                <span class="player-info">${player.name} (${player.position} - ${player.team})</span>
                                <div class="player-actions">
                                    <button class="btn btn-small" onclick="movePlayer('${teamId}', '${player.player_id}', 'starter')">To Starter</button>
                                    <button class="btn btn-small btn-danger" onclick="removePlayer('${teamId}', '${player.player_id}')">Remove</button>
                                </div>
                            </div>
                        `;
                    });
                    rosterHTML += '</div>';
                }
                
                rosterHTML += '</div>';
                rosterContent.innerHTML = rosterHTML;
                
            } catch (error) {
                rosterContent.innerHTML = `<p class="error">Error loading roster: ${error.message}</p>`;
            }
        }

        async function addPlayerToRoster() {
            const teamId = document.getElementById('team-select').value;
            const playerId = document.getElementById('player-select').value;
            const rosterPosition = document.getElementById('position-select').value;
            
            if (!teamId || !playerId) {
                showMessage('Please select both a team and a player', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/teams/${teamId}/roster/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: playerId,
                        rosterPosition: rosterPosition
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTeamRoster(); // Refresh roster display
                    loadAvailablePlayers(); // Refresh available players
                    document.getElementById('player-select').value = ''; // Reset selection
                } else {
                    showMessage(`Failed to add player: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`Error adding player: ${error.message}`, 'error');
            }
        }

        async function movePlayer(teamId, playerId, newPosition) {
            try {
                const response = await fetch(`/api/teams/${teamId}/roster/move`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: playerId,
                        rosterPosition: newPosition
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTeamRoster(); // Refresh roster display
                } else {
                    showMessage(`Failed to move player: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`Error moving player: ${error.message}`, 'error');
            }
        }

        async function removePlayer(teamId, playerId) {
            if (!confirm('Are you sure you want to remove this player from the roster?')) {
                return;
            }

            try {
                const response = await fetch(`/api/teams/${teamId}/roster/remove`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerId: playerId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTeamRoster(); // Refresh roster display
                    loadAvailablePlayers(); // Refresh available players
                } else {
                    showMessage(`Failed to remove player: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`Error removing player: ${error.message}`, 'error');
            }
        }

        // Settings Functions
        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/league/settings');
                const result = await response.json();
                
                if (result.success) {
                    const settings = result.data;
                    
                    // Update form fields
                    document.getElementById('current-week').value = settings.current_week || '';
                    document.getElementById('season-year').value = settings.season_year || '';
                    document.getElementById('league-name').value = settings.league_name || '';
                    
                    // Update current settings display
                    const settingsDisplay = document.getElementById('current-settings');
                    settingsDisplay.innerHTML = `
                        <div class="setting-item">
                            <span class="setting-label">League Name:</span>
                            <span class="setting-value">${settings.league_name || 'Not set'}</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Current Week:</span>
                            <span class="setting-value">Week ${settings.current_week || 'Not set'}</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Season Year:</span>
                            <span class="setting-value">${settings.season_year || 'Not set'}</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Max Teams:</span>
                            <span class="setting-value">${settings.max_teams || 'Not set'}</span>
                        </div>
                        <div class="setting-item">
                            <span class="setting-label">Scoring Type:</span>
                            <span class="setting-value">${settings.scoring_type || 'Not set'}</span>
                        </div>
                    `;
                } else {
                    showSettingsMessage('Failed to load current settings', 'error');
                }
            } catch (error) {
                showSettingsMessage(`Error loading settings: ${error.message}`, 'error');
            }
        }

        async function updateSettings() {
            const currentWeek = document.getElementById('current-week').value;
            const seasonYear = document.getElementById('season-year').value;
            const leagueName = document.getElementById('league-name').value;
            
            // Validate inputs
            if (currentWeek && (currentWeek < 1 || currentWeek > 18)) {
                showSettingsMessage('Week must be between 1 and 18', 'error');
                return;
            }
            
            if (seasonYear && (seasonYear < 2020 || seasonYear > 2030)) {
                showSettingsMessage('Season year must be between 2020 and 2030', 'error');
                return;
            }
            
            // Build update object
            const updates = {};
            if (currentWeek) updates.current_week = parseInt(currentWeek);
            if (seasonYear) updates.season_year = parseInt(seasonYear);
            if (leagueName) updates.league_name = leagueName;
            
            if (Object.keys(updates).length === 0) {
                showSettingsMessage('Please enter at least one value to update', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/league/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSettingsMessage(result.message, 'success');
                    // Reload current settings to show updates
                    setTimeout(() => {
                        loadCurrentSettings();
                        // If rosters tab is visible, refresh roster info
                        const rostersTab = document.getElementById('rosters-tab');
                        if (rostersTab && rostersTab.classList.contains('active')) {
                            loadRosterWeekInfo();
                            // If a team is selected, reload its roster
                            const selectedTeam = document.getElementById('roster-team-filter').value;
                            if (selectedTeam) {
                                loadRoster();
                            }
                        }
                    }, 500);
                } else {
                    showSettingsMessage(`Failed to update settings: ${result.error}`, 'error');
                }
            } catch (error) {
                showSettingsMessage(`Error updating settings: ${error.message}`, 'error');
            }
        }

        async function captureSnapshot() {
            const week = document.getElementById('snapshot-week').value;
            
            if (!week || week < 1 || week > 18) {
                showSnapshotMessage('Please enter a valid week number (1-18)', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/roster-history/capture/${week}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSnapshotMessage(`Successfully captured ${result.entries_captured} roster entries for Week ${week}`, 'success');
                    // Clear the input
                    document.getElementById('snapshot-week').value = '';
                    // Refresh available snapshots
                    setTimeout(() => {
                        showAvailableSnapshots();
                    }, 500);
                } else {
                    showSnapshotMessage(`Failed to capture snapshot: ${result.error}`, 'error');
                }
            } catch (error) {
                showSnapshotMessage(`Error capturing snapshot: ${error.message}`, 'error');
            }
        }

        async function showAvailableSnapshots() {
            try {
                const response = await fetch('/api/roster-history/snapshots');
                const result = await response.json();
                
                const snapshotsDisplay = document.getElementById('available-snapshots');
                
                if (result.success && result.snapshots.length > 0) {
                    let snapshotsHTML = '<h4>Available Snapshots:</h4>';
                    result.snapshots.forEach(snapshot => {
                        const date = new Date(snapshot.snapshot_date).toLocaleDateString();
                        snapshotsHTML += `
                            <div class="snapshot-item">
                                <span><strong>Week ${snapshot.week}</strong> - ${snapshot.roster_count} entries</span>
                                <span>Captured: ${date}</span>
                            </div>
                        `;
                    });
                    snapshotsDisplay.innerHTML = snapshotsHTML;
                } else {
                    snapshotsDisplay.innerHTML = '<p>No roster snapshots found</p>';
                }
            } catch (error) {
                showSnapshotMessage(`Error loading snapshots: ${error.message}`, 'error');
            }
        }

        function showSettingsMessage(message, type) {
            const messagesContainer = document.getElementById('settings-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function showSnapshotMessage(message, type) {
            const messagesContainer = document.getElementById('snapshot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Load settings when the settings tab is shown
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show the selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark the clicked tab as active
            event.target.classList.add('active');
            
            // Load settings if settings tab is selected
            if (tabName === 'settings') {
                loadCurrentSettings();
            }
            
            // Load specific data for other tabs if needed
            if (tabName === 'players') {
                loadPlayers();
            } else if (tabName === 'teams') {
                loadTeams();
            } else if (tabName === 'rosters') {
                loadRosters();
            } else if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'admin') {
                loadTeamOptions();
                loadPlayerOptions();
                checkHealth();
            }
        }
    </script>
</body>
</html>