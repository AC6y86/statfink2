<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>StatFink Fantasy League - 2025 Payouts</title>
    <link href="/statfink-styles.css" rel="stylesheet" type="text/css" media="all" />
    <script src="/theme-loader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--theme-text-light);
            font-family: arial, sans-serif;
        }

        .page-header {
            background-color: var(--theme-primary-bg);
            color: var(--theme-text-light);
            font-size: 24px;
            font-weight: 900;
            padding: 15px;
            text-align: center;
        }

        .content-wrapper {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Prize Structure */
        .prize-structure {
            background: var(--theme-header-bg);
            border: 1px solid var(--theme-border);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 13px;
        }

        .prize-structure .prize-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 12px;
            color: var(--theme-primary-bg);
            border-bottom: 1px solid var(--theme-border);
            padding-bottom: 8px;
        }

        .prize-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .prize-category {
            background: var(--theme-text-light);
            border: 1px solid var(--theme-border);
            border-radius: 4px;
            padding: 10px;
        }

        .prize-category h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: var(--theme-primary-bg);
        }

        .prize-category ul {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
        }

        .prize-category li {
            margin-bottom: 3px;
        }

        .prize-total {
            font-weight: bold;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--theme-border);
        }

        /* Main table */
        .payout-table {
            border: 1px solid var(--theme-primary-bg);
            border-collapse: collapse;
            background: var(--theme-text-light);
            width: 100%;
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--theme-text-light);
            font-size: 16px;
            font-weight: 900;
            background-color: var(--theme-primary-bg);
            padding: 10px;
            text-align: center;
        }

        .payout-table th {
            color: var(--theme-text);
            font-size: 13px;
            font-weight: bold;
            background-color: var(--theme-header-bg);
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--theme-primary-bg);
        }

        .payout-table td {
            padding: 8px 10px;
            font-size: 13px;
        }

        .payout-table th.right, .payout-table td.right {
            text-align: right;
        }

        .row1 { background-color: var(--theme-text-light); }
        .row2 { background-color: var(--theme-row-alt); }

        .money { font-weight: bold; color: #228B22; }
        .expense { font-weight: bold; color: #CC0000; }

        /* Summary */
        .summary-line {
            text-align: right;
            padding: 10px 0;
            font-size: 16px;
            font-weight: bold;
            border-top: 2px solid var(--theme-primary-bg);
        }

        /* Net Summary */
        .net-summary {
            background: var(--theme-header-bg);
            border: 1px solid var(--theme-border);
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .net-summary-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--theme-primary-bg);
        }

        .net-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px 12px;
            font-size: 12px;
        }

        .net-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .net-summary-item span:last-child {
            font-weight: bold;
            margin-left: 8px;
        }

        /* Collapsible details */
        details {
            margin-bottom: 15px;
            border: 1px solid var(--theme-border);
            border-radius: 4px;
        }

        summary {
            background: var(--theme-header-bg);
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        summary:hover {
            background: var(--theme-row-alt);
        }

        details[open] summary {
            border-bottom: 1px solid var(--theme-border);
        }

        .details-content {
            padding: 10px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .detail-table {
            border: 1px solid var(--theme-border);
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .detail-table th, .detail-table td {
            padding: 5px 8px;
            border-bottom: 1px solid var(--theme-border);
        }

        .detail-table th {
            background: var(--theme-header-bg);
            text-align: left;
            font-weight: bold;
        }

        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #CC0000; color: white; padding: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="page-header">2025 Season Payouts</div>

    <div class="content-wrapper">
        <div id="loadingMessage" class="loading">Calculating payouts...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="payoutsContent" style="display: none;">
            <!-- Prize Structure -->
            <div class="prize-structure">
                <div class="prize-title">Prize Structure (12-Team League) â€” $250 Buy-in per Owner = $3,000 Total</div>
                <div class="prize-grid">
                    <div class="prize-category">
                        <h4>Weekly High Score</h4>
                        <ul>
                            <li>Weeks 1-16: $37.78/wk</li>
                            <li>Weeks 17-18: $37.76/wk</li>
                        </ul>
                        <div class="prize-total">Total: $680</div>
                    </div>
                    <div class="prize-category">
                        <h4>Cumulative Points (Week 17)</h4>
                        <ul>
                            <li>1st: $500</li>
                            <li>2nd: $300</li>
                            <li>3rd: $200</li>
                            <li>4th: $150</li>
                            <li>5th: $100</li>
                            <li>6th: $70</li>
                        </ul>
                        <div class="prize-total">Total: $1,320</div>
                    </div>
                    <div class="prize-category">
                        <h4>Head-to-Head Record</h4>
                        <ul>
                            <li>1st: $400</li>
                            <li>2nd: $300</li>
                            <li>3rd: $200</li>
                            <li>4th: $100</li>
                        </ul>
                        <div class="prize-total">Total: $1,000</div>
                    </div>
                    <div class="prize-category">
                        <h4>IR Pool ($10/move)</h4>
                        <ul>
                            <li>1st Points: 25%</li>
                            <li>1st H2H: 25%</li>
                            <li>2nd Points: 15%</li>
                            <li>2nd H2H: 15%</li>
                            <li>3rd Points: 10%</li>
                            <li>3rd H2H: 10%</li>
                        </ul>
                        <div class="prize-total">Total: $380 (38 moves)</div>
                    </div>
                </div>
            </div>

            <!-- Net Summary -->
            <div class="net-summary">
                <div class="net-summary-title">Net Summary</div>
                <div class="net-summary-grid" id="netSummaryGrid"></div>
            </div>

            <!-- Main Results Table -->
            <table class="payout-table">
                <tr><td colspan="6" class="section-title">Final Payouts</td></tr>
                <tr>
                    <th>Owner</th>
                    <th class="right">Weekly</th>
                    <th class="right">Points</th>
                    <th class="right">H2H</th>
                    <th class="right">IR Pool</th>
                    <th class="right">Net</th>
                </tr>
                <tbody id="finalTotalsBody"></tbody>
            </table>

            <div class="summary-line">
                Total Distributed: <span id="summaryGrandTotal" class="money">$0</span>
            </div>

            <!-- Collapsible Details -->
            <details open>
                <summary>Standings & IR Pool Breakdown</summary>
                <div class="details-content">
                    <div class="details-grid">
                        <div>
                            <h4 style="margin: 0 0 8px 0;">Cumulative Points (Week 17)</h4>
                            <table class="detail-table">
                                <tr><th>Rank</th><th>Owner</th><th class="right">Points</th><th class="right">Prize</th></tr>
                                <tbody id="pointsStandingsBody"></tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 8px 0;">Head-to-Head Record</h4>
                            <table class="detail-table">
                                <tr><th>Rank</th><th>Owner</th><th class="right">Prize</th></tr>
                                <tbody id="h2hStandingsBody"></tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 8px 0;">IR Pool Distribution</h4>
                            <table class="detail-table">
                                <tr><th>Category</th><th>Owner</th><th class="right">Amount</th></tr>
                                <tbody id="irPoolBody"></tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 8px 0;">IR Moves by Team</h4>
                            <table class="detail-table">
                                <tr><th>Owner</th><th class="right">Moves</th><th class="right">Fees</th></tr>
                                <tbody id="irMovesBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </details>

            <details open>
                <summary>Weekly Winners (18 weeks)</summary>
                <div class="details-content">
                    <table class="detail-table">
                        <tr><th>Owner</th><th class="right">Wins</th><th class="right">Payout</th></tr>
                        <tbody id="weeklyWinnersBody"></tbody>
                    </table>
                </div>
            </details>
        </div>
    </div>

    <script>
        function formatMoney(amount) {
            return '$' + amount.toFixed(2);
        }

        async function loadPayouts() {
            try {
                const response = await fetch('/api/payouts/2025');
                if (!response.ok) throw new Error('Failed to fetch payouts');
                const result = await response.json();
                if (!result.success) throw new Error('Failed to load payouts data');
                displayPayouts(result.data);
            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = 'Error: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        function displayPayouts(data) {
            const { summary, weeklyWinners, pointsStandings, h2hStandings, irPoolBreakdown, irMovesByTeam, payouts } = data;

            document.getElementById('summaryGrandTotal').textContent = formatMoney(summary.grandTotal);

            // IR fees lookup
            const irFeesByOwner = {};
            irMovesByTeam.forEach(m => { irFeesByOwner[m.owner_name] = m.fees; });

            // Final payouts table - simplified 6 columns
            const finalTotalsBody = document.getElementById('finalTotalsBody');
            finalTotalsBody.innerHTML = '';
            const BUY_IN = 250;
            const ownerNames = ['Chris', 'Mitch', 'Dan', 'Pete', 'Joe', 'Aaron', 'Cal', 'Bruce', 'Mike', 'Sean', 'Eli', 'Matt'];

            const allOwnerPayouts = ownerNames.map(owner => {
                const p = payouts.find(x => x.owner_name === owner) || {
                    owner_name: owner, weekly_payout: 0, points_payout: 0, h2h_payout: 0,
                    ir_pool_points_payout: 0, ir_pool_h2h_payout: 0, total: 0
                };
                const irFees = irFeesByOwner[owner] || 0;
                const irPoolTotal = p.ir_pool_points_payout + p.ir_pool_h2h_payout;
                const net = p.total - BUY_IN - irFees;
                return { ...p, irFees, irPoolTotal, net };
            }).sort((a, b) => b.net - a.net);

            allOwnerPayouts.forEach((p, i) => {
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'row1' : 'row2';
                const netClass = p.net >= 0 ? 'money' : 'expense';
                row.innerHTML = `
                    <td>${p.owner_name}</td>
                    <td class="right">${p.weekly_payout > 0 ? formatMoney(p.weekly_payout) : '-'}</td>
                    <td class="right">${p.points_payout > 0 ? formatMoney(p.points_payout) : '-'}</td>
                    <td class="right">${p.h2h_payout > 0 ? formatMoney(p.h2h_payout) : '-'}</td>
                    <td class="right">${p.irPoolTotal > 0 ? formatMoney(p.irPoolTotal) : '-'}</td>
                    <td class="right ${netClass}">${p.net >= 0 ? '+' : ''}${formatMoney(p.net)}</td>
                `;
                finalTotalsBody.appendChild(row);
            });

            // Net Summary grid
            const netSummaryGrid = document.getElementById('netSummaryGrid');
            netSummaryGrid.innerHTML = allOwnerPayouts.map(p => {
                const netClass = p.net >= 0 ? 'money' : 'expense';
                return `<div class="net-summary-item"><span>${p.owner_name}</span><span class="${netClass}">${p.net >= 0 ? '+' : ''}${formatMoney(p.net)}</span></div>`;
            }).join('');

            // Weekly winners (by total wins)
            const weeklyWinnersBody = document.getElementById('weeklyWinnersBody');
            weeklyWinnersBody.innerHTML = '';
            const winCountsArray = Object.entries(data.weeklyWinCounts)
                .map(([owner, wins]) => ({ owner, wins }))
                .sort((a, b) => b.wins - a.wins);
            winCountsArray.forEach((w, i) => {
                const ownerPayout = payouts.find(p => p.owner_name === w.owner);
                const payout = ownerPayout ? ownerPayout.weekly_payout : 0;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${w.owner}</td><td class="right">${w.wins}</td><td class="right money">${formatMoney(payout)}</td>`;
                weeklyWinnersBody.appendChild(row);
            });

            // Points standings
            const pointsStandingsBody = document.getElementById('pointsStandingsBody');
            pointsStandingsBody.innerHTML = '';
            pointsStandings.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.rank}</td><td>${p.owner_name}</td><td class="right">${p.cumulative_points.toFixed(1)}</td><td class="right money">${formatMoney(p.payout)}</td>`;
                pointsStandingsBody.appendChild(row);
            });

            // H2H standings
            const h2hStandingsBody = document.getElementById('h2hStandingsBody');
            h2hStandingsBody.innerHTML = '';
            h2hStandings.forEach(h => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${h.rank}</td><td>${h.owner_name}</td><td class="right money">${formatMoney(h.payout)}</td>`;
                h2hStandingsBody.appendChild(row);
            });

            // IR Pool breakdown
            const irPoolBody = document.getElementById('irPoolBody');
            irPoolBody.innerHTML = '';
            [
                { cat: '1st Points (25%)', owner: irPoolBreakdown.points_1st.owner, amt: irPoolBreakdown.points_1st.amount },
                { cat: '1st H2H (25%)', owner: irPoolBreakdown.h2h_1st.owner, amt: irPoolBreakdown.h2h_1st.amount },
                { cat: '2nd Points (15%)', owner: irPoolBreakdown.points_2nd.owner, amt: irPoolBreakdown.points_2nd.amount },
                { cat: '2nd H2H (15%)', owner: irPoolBreakdown.h2h_2nd.owner, amt: irPoolBreakdown.h2h_2nd.amount },
                { cat: '3rd Points (10%)', owner: irPoolBreakdown.points_3rd.owner, amt: irPoolBreakdown.points_3rd.amount },
                { cat: '3rd H2H (10%)', owner: irPoolBreakdown.h2h_3rd.owner, amt: irPoolBreakdown.h2h_3rd.amount }
            ].forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${r.cat}</td><td>${r.owner}</td><td class="right money">${formatMoney(r.amt)}</td>`;
                irPoolBody.appendChild(row);
            });

            // IR moves
            const irMovesBody = document.getElementById('irMovesBody');
            irMovesBody.innerHTML = '';
            irMovesByTeam.sort((a, b) => b.move_count - a.move_count).forEach(m => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${m.owner_name}</td><td class="right">${m.move_count}</td><td class="right expense">-${formatMoney(m.fees)}</td>`;
                irMovesBody.appendChild(row);
            });

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('payoutsContent').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', loadPayouts);
    </script>
</body>
</html>
