<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>StatFink Fantasy League - Rosters</title>
    <link href="/statfink-styles.css" rel="stylesheet" type="text/css" media="all" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
            font-family: arial, sans-serif;
        }
        
        .page-header {
            background-color: #556;
            color: #fff;
            font-size: 24px;
            font-family: arial;
            font-weight: 900;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #343443;
        }
        
        .content-wrapper {
            padding: 20px;
        }
        
        .rosters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: start;
        }
        
        .team-roster {
            background: #fff;
            border: 1px solid #556;
            border-collapse: collapse;
            margin-bottom: 0;
            position: relative;
        }
        
        .team-header {
            background-color: #556;
            color: #fff;
            padding: 8px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #343443;
        }
        
        .roster-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            padding: 0;
            position: relative;
        }
        
        .roster-table th {
            background-color: #ddd;
            color: #000;
            font-size: 11px;
            font-weight: bold;
            padding: 5px 8px;
            text-align: left;
            border-bottom: 1px solid #556;
            white-space: nowrap;
        }
        
        .roster-table td {
            padding: 4px 8px;
            font-size: 11px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .roster-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Allow wrapping only in injury description tooltips */
        .injury-tooltip {
            white-space: normal !important;
        }
        
        .position-qb { color: #b83535; }
        .position-rb { color: #2e7d32; }
        .position-wr { color: #1565c0; }
        .position-te { color: #e65100; }
        .position-k { color: #6a1b9a; }
        .position-def { color: #5d4037; }
        .position-defense { color: #5d4037; }
        
        .status-ir {
            color: #b83535;
        }
        
        .injury-status {
            font-weight: bold;
        }
        
        .injury-out {
            color: #b83535;
        }
        
        .injury-questionable {
            color: #ff9800;
        }
        
        .injury-doubtful {
            color: #ff5722;
        }
        
        .injury-cell {
            cursor: help;
            position: relative;
            overflow: visible !important;
        }
        
        .injury-tooltip {
            display: none;
            position: absolute;
            background: #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            width: 250px;
            z-index: 1000;
            left: 0;
            top: 100%;
            margin-top: 2px;
            white-space: normal;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .injury-cell:hover .injury-tooltip {
            display: block;
        }
        
        .scoring-player {
            background-color: #fff3cd;
        }
        
        .row1 {
            background-color: #fff;
        }
        
        .row2 {
            background-color: #f0f0f0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 12px;
        }
        
        .error {
            background: #b83535;
            color: #fff;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
        }
        
        /* Bold styling for changed rosters */
        .roster-changed {
            font-weight: bold !important;
        }
        
        .player-count {
            font-size: 10px;
            color: #666;
            text-align: center;
            padding: 5px;
            border-top: 1px solid #556;
            background-color: #f5f5f5;
            margin: 0;
            line-height: 1.2;
            display: block;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="page-header" id="pageHeader">
        Week X Rosters
    </div>
    
    <div class="content-wrapper">
        <div id="loadingMessage" class="loading">Loading rosters...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <div class="rosters-grid" id="rostersGrid" style="display: none;">
            <!-- Team rosters will be populated here -->
        </div>
    </div>
    
    <script>
        let currentSeason = 2024;
        let currentWeek = 1;
        
        // Storage key for roster data
        function getStorageKey(season, week) {
            return `statfink_rosters_${season}_${week}`;
        }
        
        // Clean up old localStorage entries (older than 24 hours)
        function cleanupOldRosters() {
            const keys = Object.keys(localStorage);
            const now = Date.now();
            const ONE_DAY = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            
            keys.forEach(key => {
                if (key.startsWith('statfink_rosters_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data && data.timestamp) {
                            const age = now - data.timestamp;
                            if (age > ONE_DAY) {
                                localStorage.removeItem(key);
                                console.log(`Removed old roster cache: ${key} (${Math.round(age / 3600000)} hours old)`);
                            }
                        }
                    } catch (e) {
                        // If we can't parse it, remove it
                        localStorage.removeItem(key);
                        console.log(`Removed invalid roster cache: ${key}`);
                    }
                }
            });
        }
        
        // Get previous roster data from localStorage
        function getPreviousRosters(season, week) {
            const storageKey = getStorageKey(season, week);
            const saved = localStorage.getItem(storageKey);
            return saved ? JSON.parse(saved) : null;
        }
        
        // Save current roster data with change timestamps
        function saveCurrentRosters(season, week, teams, changedPlayers) {
            const storageKey = getStorageKey(season, week);
            const previousData = getPreviousRosters(season, week);
            const now = Date.now();
            
            const dataToSave = {
                timestamp: now,
                teams: {}
            };
            
            teams.forEach(team => {
                dataToSave.teams[team.team_id] = {
                    roster: {},
                    lastChanged: {}
                };
                
                team.roster.forEach(player => {
                    // Create a simplified player object for comparison
                    const playerData = {
                        name: player.name,
                        position: player.position,
                        team: player.team,
                        status: player.status,
                        injury_designation: player.injury_designation
                    };
                    
                    dataToSave.teams[team.team_id].roster[player.player_id] = playerData;
                    
                    // Track when this player changed
                    const teamChanges = changedPlayers[team.team_id] || [];
                    if (teamChanges.includes(player.player_id)) {
                        // Player just changed
                        dataToSave.teams[team.team_id].lastChanged[player.player_id] = now;
                    } else if (previousData?.teams?.[team.team_id]?.lastChanged?.[player.player_id]) {
                        // Preserve previous change time
                        dataToSave.teams[team.team_id].lastChanged[player.player_id] = 
                            previousData.teams[team.team_id].lastChanged[player.player_id];
                    }
                });
            });
            
            localStorage.setItem(storageKey, JSON.stringify(dataToSave));
        }
        
        // Compare rosters and return changed players (with 1-minute window)
        function compareRosters(currentTeams, previousData) {
            if (!previousData || !previousData.timestamp) return {};
            
            const changes = {};
            const now = Date.now();
            const ONE_MINUTE = 60 * 1000; // 1 minute in milliseconds
            
            currentTeams.forEach(team => {
                const prevTeam = previousData.teams?.[team.team_id];
                if (!prevTeam) return;
                
                const teamChanges = [];
                
                // Check each current player
                team.roster.forEach(player => {
                    const prevPlayer = prevTeam.roster[player.player_id];
                    
                    // Check if player is new or changed
                    const hasChanged = !prevPlayer || 
                        prevPlayer.status !== player.status ||
                        prevPlayer.injury_designation !== player.injury_designation ||
                        prevPlayer.team !== player.team;
                    
                    if (hasChanged) {
                        // Player just changed - mark as bold
                        teamChanges.push(player.player_id);
                    } else if (prevTeam.lastChanged?.[player.player_id]) {
                        // Player hasn't changed - check if it should still be bold
                        const timeSinceChange = now - prevTeam.lastChanged[player.player_id];
                        if (timeSinceChange <= ONE_MINUTE) {
                            // Still within 1-minute window - keep bold
                            teamChanges.push(player.player_id);
                        }
                        // If > 1 minute, don't add to teamChanges (unbold)
                    }
                });
                
                // Check for removed players (within 1-minute window)
                Object.keys(prevTeam.roster).forEach(playerId => {
                    if (!team.roster.find(p => p.player_id === playerId)) {
                        // Player was removed - check if removal should still be noted
                        if (prevTeam.lastChanged?.[playerId]) {
                            const timeSinceChange = now - prevTeam.lastChanged[playerId];
                            if (timeSinceChange <= ONE_MINUTE) {
                                // Recent removal - could add a note if needed
                                console.log(`Player ${playerId} recently removed from team ${team.team_id}`);
                            }
                        }
                    }
                });
                
                if (teamChanges.length > 0) {
                    changes[team.team_id] = teamChanges;
                }
            });
            
            return changes;
        }
        
        // Initialize the page
        async function init() {
            try {
                // Clean up old localStorage entries on page load
                cleanupOldRosters();
                
                // Parse season and week from URL
                const pathParts = window.location.pathname.split('/');
                if (pathParts.length >= 4 && pathParts[1] === 'rosters') {
                    const urlSeason = parseInt(pathParts[2]);
                    const urlWeek = parseInt(pathParts[3]);
                    if (!isNaN(urlSeason) && !isNaN(urlWeek)) {
                        currentSeason = urlSeason;
                        currentWeek = urlWeek;
                    }
                }
                
                // Load rosters
                loadRosters(currentSeason, currentWeek);
                
            } catch (error) {
                console.error('Error initializing:', error);
                showError('Failed to initialize rosters page');
            }
        }
        
        // Load rosters for a specific week
        async function loadRosters(season, week) {
            showLoading();
            hideError();
            
            try {
                const response = await fetch(`/api/rosters/${season}/${week}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch rosters');
                }
                
                const data = await response.json();
                
                // Get previous roster data before saving new ones
                const previousRosters = getPreviousRosters(season, week);
                
                // Compare rosters to find changes
                const changedPlayers = compareRosters(data.data.teams, previousRosters);
                
                // Debug logging
                if (previousRosters) {
                    console.log('Previous rosters found, comparing changes...');
                    console.log('Changed players:', changedPlayers);
                } else {
                    console.log('No previous rosters found - first load');
                }
                
                // Display rosters with change highlighting
                displayRosters(data.data, changedPlayers);
                
                // Save current rosters for next comparison
                saveCurrentRosters(season, week, data.data.teams, changedPlayers);
                
            } catch (error) {
                console.error('Error loading rosters:', error);
                showError('Failed to load roster data');
            }
        }
        
        // Display rosters data
        function displayRosters(data, changedPlayers = {}) {
            const { season, week, teams } = data;
            
            // Update page header
            document.getElementById('pageHeader').textContent = `Week ${week} Rosters`;
            
            // Display team rosters
            const rostersGrid = document.getElementById('rostersGrid');
            rostersGrid.innerHTML = '';
            
            teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-roster';
                
                // Extract first name from owner_name
                const firstName = team.owner_name ? team.owner_name.split(' ')[0].replace("'s", '') : team.team_name;
                
                // Create team header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'team-header';
                headerDiv.textContent = firstName;
                teamDiv.appendChild(headerDiv);
                
                // Create roster table
                const table = document.createElement('table');
                table.className = 'roster-table';
                
                // Add table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th style="width: 35px;">Pos</th>
                        <th style="max-width: 150px;">Player</th>
                        <th style="width: 35px;">Team</th>
                        <th style="width: 40px;">Status</th>
                        <th style="width: 85px;">Injury</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Add table body
                const tbody = document.createElement('tbody');
                
                // Group players by position
                const positions = ['QB', 'RB', 'WR', 'TE', 'K', 'Defense'];
                let rowIndex = 0;
                let activeCount = 0;
                let irCount = 0;
                
                positions.forEach(pos => {
                    const playersAtPosition = team.roster.filter(p => p.position === pos);
                    
                    playersAtPosition.forEach(player => {
                        // Skip players with no name (potential blank entries)
                        if (!player.name || player.name.trim() === '') {
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        row.className = rowIndex % 2 === 0 ? 'row1' : 'row2';
                        
                        if (player.is_scoring) {
                            row.classList.add('scoring-player');
                        }
                        
                        // Check if this player has changed
                        const teamChanges = changedPlayers[team.team_id] || [];
                        const isChanged = teamChanges.includes(player.player_id);
                        
                        const posClass = `position-${pos.toLowerCase()}`;
                        const statusClass = player.status === 'IR' ? 'status-ir' : '';
                        
                        // Add roster-changed class to player name if changed
                        const nameClass = isChanged ? 'roster-changed' : '';
                        
                        // Format player name if too long
                        const displayName = formatPlayerName(player.name);
                        
                        // Format injury display
                        let injuryCell = '<td>-</td>';
                        if (player.injury_designation) {
                            const injuryClass = getInjuryClass(player.injury_designation);
                            const tooltip = player.injury_description ? 
                                `<div class="injury-tooltip">${player.injury_description}</div>` : '';
                            injuryCell = `<td class="injury-cell">
                                <span class="injury-status ${injuryClass}">${player.injury_designation}</span>
                                ${tooltip}
                            </td>`;
                        }
                        
                        row.innerHTML = `
                            <td class="${posClass}">${pos}</td>
                            <td class="${nameClass}" style="max-width: 150px;" title="${player.name}">${displayName}</td>
                            <td>${player.team || '-'}</td>
                            <td class="${statusClass}">${player.status}</td>
                            ${injuryCell}
                        `;
                        
                        tbody.appendChild(row);
                        rowIndex++;
                        
                        if (player.status === 'IR') {
                            irCount++;
                        } else {
                            activeCount++;
                        }
                    });
                });
                
                table.appendChild(tbody);
                teamDiv.appendChild(table);
                
                // Add player count
                const countDiv = document.createElement('div');
                countDiv.className = 'player-count';
                countDiv.textContent = `Active: ${activeCount} | IR: ${irCount} | Total: ${team.roster.length}`;
                teamDiv.appendChild(countDiv);
                
                rostersGrid.appendChild(teamDiv);
            });
            
            // Show grid and hide loading
            document.getElementById('rostersGrid').style.display = 'grid';
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        // Helper functions
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('rostersGrid').style.display = 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        // Format long player names to use first initial
        function formatPlayerName(fullName, maxLength = 18) {
            if (!fullName || fullName.length <= maxLength) {
                return fullName;
            }
            
            // Split name into parts
            const parts = fullName.trim().split(/\s+/);
            
            // If single word name, return as is (shouldn't truncate)
            if (parts.length === 1) {
                return fullName;
            }
            
            // Get first name and convert to initial
            const firstName = parts[0];
            const firstInitial = firstName.charAt(0).toUpperCase() + '.';
            
            // Reconstruct with initial + rest of name
            const restOfName = parts.slice(1).join(' ');
            const shortened = firstInitial + ' ' + restOfName;
            
            // If still too long, return the shortened version anyway
            // (better than truncating with ellipsis)
            return shortened;
        }
        
        // Get CSS class for injury designation
        function getInjuryClass(designation) {
            const d = designation.toLowerCase();
            if (d === 'out' || d === 'injured reserve') {
                return 'injury-out';
            } else if (d === 'questionable') {
                return 'injury-questionable';
            } else if (d === 'doubtful') {
                return 'injury-doubtful';
            }
            return '';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>